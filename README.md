# XTF - Excel To Feishu 智能同步工具

XTF (Excel To Feishu) 是一个企业级的本地 Excel 表格到飞书多维表格的智能同步工具。支持四种同步模式，具备智能字段管理、类型转换、频率控制、重试机制等企业级功能特性。

## ✨ 核心特性

### 🔄 四种智能同步模式

| 模式 | 描述 | 适用场景 |
|------|------|----------|
| **全量同步 (full)** | 已存在索引值的记录执行**更新**，不存在的执行**新增** | 日常数据同步，既有更新又有新增 |
| **增量同步 (incremental)** | 已存在索引值的记录**跳过**，只新增不存在的记录 | 只添加新数据，保护已有数据 |
| **覆盖同步 (overwrite)** | 删除已存在索引值的远程记录，然后新增本地全部记录 | 本地数据为准，覆盖部分远程数据 |
| **克隆同步 (clone)** | 清空远程表格全部数据，然后新增本地全部记录 | 完全重建远程表格，数据迁移 |

### 🚀 企业级功能

- **🎯 智能字段管理**: 自动分析并创建目标表缺少的字段，支持多种字段类型
- **🔄 智能类型转换**: 自动识别并转换数字、日期、布尔值、单选、多选等类型
- **📊 大数据支持**: 分页处理，批量操作，支持大规模数据同步
- **🛡️ 频率控制**: 内置 Rate Limiter，防止 API 调用过频，符合飞书限制
- **🔁 智能重试**: 指数退避算法，自动处理网络异常和服务器错误
- **⚡ 性能优化**: 批处理 + 一致性检查跳过 + 并发优化
- **📝 详细日志**: 双输出(文件+控制台)，中英文混合，分级记录
- **🔧 灵活配置**: YAML 配置文件 + 命令行参数，支持多环境配置

### 🧠 智能数据处理

- **类型智能推断**: 根据 Excel 数据特征自动推荐最适合的飞书字段类型
- **强制类型转换**: 即使数据类型不匹配也能智能转换，减少同步失败
- **数据清理**: 自动处理空值、特殊字符、格式问题
- **转换统计报告**: 详细的数据转换成功率和问题分析报告

## 🛠️ 安装要求

### 快速安装
```bash
# 安装依赖
pip install -r requirements.txt

# 或手动安装
pip install pandas>=1.5.0 requests>=2.25.0 openpyxl>=3.0.0 PyYAML>=6.0.0
```

### 系统要求
- **Python**: 3.7+
- **内存**: 推荐 2GB+ (取决于数据量)
- **网络**: 需要访问飞书 API
- **权限**: 飞书应用读写权限

## ⚙️ 配置设置

### 1. 飞书应用配置

在[飞书开放平台](https://open.feishu.cn/)创建应用并获取：

| 参数 | 说明 | 获取方式 |
|------|------|----------|
| `app_id` | 应用ID | 应用凭证页面 |
| `app_secret` | 应用密钥 | 应用凭证页面 |
| `app_token` | 多维表格应用Token | 多维表格分享链接中提取 |
| `table_id` | 数据表ID | 多维表格URL中提取 |

### 2. 配置文件设置

#### 创建配置文件
```bash
# 复制示例配置文件
cp config.example.yaml config.yaml

# 或让程序自动创建
python XTF.py --config my_config.yaml
```

#### 配置文件格式 (YAML)
```yaml
# XTF 配置文件
file_path: "data.xlsx"                    # Excel文件路径
app_id: "cli_your_app_id_here"           # 飞书应用ID
app_secret: "your_app_secret_here"       # 飞书应用密钥
app_token: "your_app_token_here"         # 多维表格应用Token
table_id: "your_table_id_here"           # 数据表ID

# 同步设置
sync_mode: "full"                        # 同步模式
index_column: "ID"                       # 索引列名

# 性能设置
batch_size: 500                          # 批处理大小
rate_limit_delay: 0.5                    # 接口调用间隔(秒)
max_retries: 3                           # 最大重试次数

# 功能开关
create_missing_fields: true              # 自动创建缺失字段

# 日志设置
log_level: "INFO"                        # 日志级别
```

### 3. 参数优先级

XTF 使用三层参数优先级 (**从低到高**)：

```
默认值 < 配置文件 < 命令行参数
```

- 📄 **配置文件参数** 覆盖默认值
- 🖥️ **命令行参数** 覆盖配置文件参数
- 只有明确指定的命令行参数才会覆盖，未指定的保持配置文件值

## 🚀 使用方法

### 基础使用
```bash
# 使用默认配置文件 (config.yaml)
python XTF.py

# 使用自定义配置文件
python XTF.py --config my_config.yaml

# 显示帮助信息
python XTF.py --help
```

### 命令行参数覆盖
```bash
# 临时更改同步模式
python XTF.py --sync-mode incremental

# 临时更改文件路径和索引列
python XTF.py --file-path data.xlsx --index-column "员工ID"

# 性能调优
python XTF.py --batch-size 1000 --rate-limit-delay 0.2

# 调试模式
python XTF.py --log-level DEBUG --batch-size 10
```

### 多环境配置
```bash
# 开发环境
python XTF.py --config dev.yaml

# 测试环境
python XTF.py --config test.yaml --sync-mode incremental

# 生产环境
python XTF.py --config prod.yaml --batch-size 1000
```

### 完整参数列表

| 参数 | 类型 | 默认值 | 说明 |
|------|------|--------|------|
| `--config` | str | config.yaml | 配置文件路径 |
| `--file-path` | str | - | Excel文件路径 |
| `--app-id` | str | - | 飞书应用ID |
| `--app-secret` | str | - | 飞书应用密钥 |
| `--app-token` | str | - | 多维表格应用Token |
| `--table-id` | str | - | 数据表ID |
| `--sync-mode` | str | full | 同步模式 |
| `--index-column` | str | - | 索引列名 |
| `--batch-size` | int | 500 | 批处理大小 |
| `--rate-limit-delay` | float | 0.5 | API调用间隔(秒) |
| `--max-retries` | int | 3 | 最大重试次数 |
| `--no-create-fields` | flag | false | 禁用自动创建字段 |
| `--log-level` | str | INFO | 日志级别 |

## 📊 同步模式详解

### 🔄 全量同步 (推荐)
```bash
python XTF.py --sync-mode full --index-column "ID"
```
**工作流程**:
1. 读取本地 Excel 数据
2. 获取飞书表格现有数据并建立索引
3. 根据索引列值比对，已存在的**更新**，不存在的**新增**

**适用场景**: 日常数据维护，既有数据更新又有新增记录

### ➕ 增量同步
```bash
python XTF.py --sync-mode incremental --index-column "ID"
```
**工作流程**:
1. 读取本地 Excel 数据
2. 获取飞书表格现有数据索引
3. 只处理飞书表格中不存在索引值的记录

**适用场景**: 数据追加，保护已有数据不被修改

### 🔄 覆盖同步
```bash
python XTF.py --sync-mode overwrite --index-column "ID"
```
**工作流程**:
1. 读取本地 Excel 数据
2. 删除飞书表格中索引值匹配的记录
3. 新增本地的全部记录

**适用场景**: 本地数据为准，覆盖部分远程数据

### 🔄 克隆同步
```bash
python XTF.py --sync-mode clone
```
**工作流程**:
1. 清空飞书表格的全部现有数据
2. 新增本地 Excel 的全部记录

**适用场景**: 数据迁移，完全重建远程表格

## 📁 项目结构

```
XTF/
├── XTF.py                      # 主程序文件
├── config.yaml                 # 主配置文件 (YAML格式)
├── config.example.yaml         # 配置文件示例
├── requirements.txt            # Python依赖清单
├── README.md                   # 项目文档
├── LICENSE                     # 开源协议
├── .gitignore                  # Git忽略文件
├── logs/                       # 日志目录 (自动创建)
│   └── xtf_YYYYMMDD_HHMMSS.log # 按时间戳命名的日志文件
└── docs/                       # 飞书API文档
    └── feishu-openapi-doc/     # 飞书开放API文档集合
```

## 🔍 智能字段类型支持

XTF 具备强大的数据类型智能识别和转换能力：

### 支持的字段类型

| Excel 数据类型 | 飞书字段类型 | 转换规则 | 示例 |
|----------------|--------------|----------|------|
| **文本** | 文本(1) | 直接转换 | `"张三"` → `"张三"` |
| **整数/小数** | 数字(2) | 保持数值，清理格式 | `"1,234.56"` → `1234.56` |
| **日期时间** | 日期(5) | 转为毫秒时间戳 | `"2024-01-01"` → `1704067200000` |
| **布尔值** | 复选框(7) | 智能识别真假值 | `"是/否"` → `true/false` |
| **分隔文本** | 多选(4) | 按分隔符拆分 | `"选项1,选项2"` → `["选项1","选项2"]` |
| **单一选项** | 单选(3) | 直接转换或取首值 | `"选项1"` → `"选项1"` |
| **用户ID** | 人员(11) | 转为用户对象 | `"ou_xxx"` → `[{"id":"ou_xxx"}]` |
| **URL链接** | 超链接(15) | 转为链接对象 | `"https://..."` → `{"text":"...","link":"..."}` |

### 智能类型推断

XTF 会分析 Excel 列的数据特征，自动推荐最合适的飞书字段类型：

```
📊 数据分析过程:
1. 统计各类型数据占比
2. 分析唯一值数量和重复率
3. 检测特殊格式(日期、数字、布尔值)
4. 推荐最佳字段类型并显示置信度
```

### 强制类型转换

即使数据类型不完全匹配，XTF 也能智能转换：

- **数字字段**: 从文本中提取数字，处理货币符号和千分位
- **日期字段**: 支持多种日期格式，智能解析时间戳
- **布尔字段**: 识别 `是/否`、`true/false`、`1/0` 等格式
- **选择字段**: 智能分割多值，处理各种分隔符

## 📝 日志与监控

### 双重日志输出
- **🖥️ 控制台输出**: 实时显示同步进度和关键信息
- **📁 文件日志**: 完整记录到 `logs/xtf_YYYYMMDD_HHMMSS.log`

### 日志级别说明
| 级别 | 用途 | 输出内容 |
|------|------|----------|
| `DEBUG` | 开发调试 | 详细的API调用、数据转换过程 |
| `INFO` | 一般信息 | 同步进度、成功统计、配置信息 |
| `WARNING` | 警告信息 | 数据转换问题、性能提醒 |
| `ERROR` | 错误信息 | 同步失败、API错误、致命错误 |

### 数据转换统计报告
每次同步完成后，XTF 会生成详细的转换统计报告：

```
🔄 数据类型转换统计报告
==========================================
📊 总转换次数: 1,234
✅ 成功转换: 1,200 (97.2%)
❌ 失败转换: 34 (2.8%)
⚠️  警告数量: 15

💡 优化建议:
1. 数据质量较高，转换成功率良好
2. 建议关注日期格式标准化
3. 检查数字字段中的非数字内容
```

## 🚨 重要注意事项

### 索引列设置
| 同步模式 | 索引列要求 | 缺失后果 |
|----------|------------|----------|
| **全量同步** | 强烈建议 | 无法区分更新/新增，可能重复 |
| **增量同步** | 强烈建议 | 无法判断已存在，可能重复 |
| **覆盖同步** | **必须** | 同步失败，程序报错 |
| **克隆同步** | 不需要 | 无影响 |

### 数据安全警告
⚠️ **高风险操作**:
- **克隆同步**: 会清空目标表格的所有数据
- **覆盖同步**: 会删除匹配的现有记录

🛡️ **安全建议**:
1. 生产环境使用前务必在测试环境验证
2. 重要数据请提前导出备份
3. 首次使用建议用小数据量测试
4. 配置合适的 `batch_size` 和 `rate_limit_delay`

### API 限制和配额
| 操作类型 | 飞书限制 | XTF 默认设置 |
|----------|----------|--------------|
| 批量创建 | 最多1000条/次 | 500条/批次 |
| 批量更新 | 最多1000条/次 | 500条/批次 |
| 批量删除 | 最多500条/次 | 500条/批次 |
| API频率 | 租户级限制 | 0.5秒/次调用 |
| 重试机制 | - | 最多3次，指数退避 |